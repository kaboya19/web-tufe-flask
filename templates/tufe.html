{% extends "base.html" %}

{% block title %}TÜFE - Web TÜFE{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="card-modern p-6">
                <form method="post" class="mb-6">
                    <label for="madde" class="block text-sm font-medium text-gray-700 mb-1">Madde Seçin:</label>
                    <div class="relative w-full">
                        <select name="madde" id="madde" onchange="this.form.submit()"
                            class="appearance-none w-full px-4 py-2 pr-10 rounded-lg border border-gray-300 bg-white shadow focus:outline-none focus:ring-2 focus:ring-[#EF476F] focus:border-[#EF476F] text-base font-semibold text-gray-700 transition duration-150 ease-in-out cursor-pointer">
                            <option value="TÜFE" {% if selected_madde=='TÜFE' %}selected{% endif %}>TÜFE</option>
                            {% for madde in madde_names %}
                            <option value="{{ madde }}" {% if selected_madde==madde %}selected{% endif %}>{{ madde }}
                            </option>
                            {% endfor %}
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M5.23 7.21a.75.75 0 011.06.02L10 10.584l3.71-3.354a.75.75 0 111.02 1.1l-4.25 3.84a.75.75 0 01-1.02 0l-4.25-3.84a.75.75 0 01.02-1.06z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </form>
                {% if last_date %}
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl shadow-md p-6 border border-blue-100">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wide">Yılbaşından İtibaren Değişim</h3>
                        <p class="text-4xl font-bold mb-1 {% if change_rate > 0 %}text-red-600{% elif change_rate < 0 %}text-green-600{% else %}text-gray-700{% endif %}">
                            {% if change_rate is not none %}
                            {{ '%.2f' % change_rate }}%
                            {% else %}
                            -
                            {% endif %}
                        </p>
                        <p class="text-xs text-gray-500">1.01.2025 - {{ last_date.strftime('%d.%m.%Y') }}</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl shadow-md p-6 border border-orange-100">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide">{{ month_name }} Aylık Değişim</h3>
                            <div class="relative group">
                                <div class="flex items-center justify-center w-5 h-5 bg-indigo-100 rounded-full cursor-help hover:bg-indigo-200 transition-colors duration-200 animate-pulse hover:animate-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="absolute left-0 top-7 w-64 bg-gray-900 text-white text-xs rounded-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 shadow-xl">
                                    <p class="leading-relaxed">Aylık değişim oranı nihai verinin kesinleştiği 24.güne kadar çeşitli modellerle ay sonu için verinin trendi ile tahmin edilmektedir.<br>
                                    Ayın 24'ünde nihai veri 24.güne kadar olan ortalamanın önceki ayın aynı dönemdeki ortalamasına göre değişimi ile oluşur.</p>
                                    <div class="absolute -top-2 left-4 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-gray-900"></div>
                                </div>
                            </div>
                        </div>
                        <p class="text-4xl font-bold mb-1 {% if monthly_change > 0 %}text-red-600{% elif monthly_change < 0 %}text-green-600{% else %}text-gray-700{% endif %}">
                            {% if monthly_change is not none %}
                            {{ '%.2f' % monthly_change }}%
                            {% else %}
                            -
                            {% endif %}
                        </p>
                        <p class="text-xs text-gray-500">Bir önceki aya göre</p>
                    </div>
                </div>
                <div id="tufe-chart" class="w-full"></div>
                {% if selected_madde != 'TÜFE' %}
                <div class="mt-12 w-full">
            <div class="btn-group flex gap-3 justify-end mb-6">
                <button id="madde-monthly-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-md active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Aylık
                        </button>
                <button id="madde-cumulative-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:text-indigo-600 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                            Kümülatif
                        </button>
                    </div>
                    <div id="monthly-change-line-chart" class="w-full" style="width: 100% !important;">
                    </div>
                </div>
                {% endif %}
                {% if selected_madde == 'TÜFE' %}
                <div class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="cumulative-checkbox" class="mr-2 w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="text-sm font-semibold text-gray-700">Kümülatif Göster</span>
                            </label>
                        </div>
                <div class="btn-group flex gap-3 justify-end">
                    <button id="bar-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-md active">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="12" width="4" height="8" />
                                    <rect x="9" y="8" width="4" height="12" />
                                    <rect x="15" y="4" width="4" height="16" />
                                </svg>
                                Bar Grafik
                            </button>
                    <button id="line-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:text-indigo-600 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4 16l4-4 4 4 8-8" />
                                </svg>
                                Line Grafik
                            </button>
                        </div>
                    </div>
                    <div id="bar-compare-chart" class="w-full"></div>
                    <div id="line-compare-chart" class="w-full hidden"></div>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center text-red-600 font-bold text-lg py-12">Veri bulunamadı.</div>
                {% endif %}
            </div>
            </div>
{% endblock %}

{% block scripts %}
    <script>
        var graphs = {{ graphJSON | safe }};
        Plotly.newPlot('tufe-chart', graphs.data, graphs.layout, { displayModeBar: false });
    </script>
    {% if selected_madde != 'TÜFE' %}
    <script>
        var monthlyChangeLineGraph = {{ line_graphJSON | safe }};
        
        // Orijinal verileri sakla
        var originalMaddeLineData = JSON.parse(JSON.stringify(monthlyChangeLineGraph));
        
        // Kümülatif hesaplama fonksiyonu (Ocak 2025 = 0 ile başlar)
        function calculateMaddeCumulative(values) {
            let cumulative = [0]; // Ocak 2025 = 0
            let cumulativeProduct = 1;
            
            for (let i = 0; i < values.length; i++) {
                if (values[i] !== null && values[i] !== undefined) {
                    cumulativeProduct *= (1 + values[i] / 100);
                    cumulative.push((cumulativeProduct - 1) * 100);
                } else {
                    cumulative.push(null);
                }
            }
            return cumulative;
        }
        
        // Ay listesine Ocak 2025 ekle
        function addMaddeJanuaryToMonths(months) {
            let newMonths = ['Ocak 2025'];
            return newMonths.concat(months);
        }
        
        Plotly.newPlot('monthly-change-line-chart', monthlyChangeLineGraph.data, monthlyChangeLineGraph.layout, { displayModeBar: false, responsive: true });

        const maddeLineChart = document.getElementById('monthly-change-line-chart');
        const maddeMonthlyBtn = document.getElementById('madde-monthly-btn');
        const maddeCumulativeBtn = document.getElementById('madde-cumulative-btn');
        
        function setMaddeMode(btn) {
        maddeMonthlyBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
        maddeMonthlyBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        
        maddeCumulativeBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
        maddeCumulativeBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        
        btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        btn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
    }
        
        // Aylık butonu handler
        maddeMonthlyBtn.addEventListener('click', function() {
            setMaddeMode(maddeMonthlyBtn);
            // Normal moda geri dön
            Plotly.react('monthly-change-line-chart', originalMaddeLineData.data, originalMaddeLineData.layout, { displayModeBar: false, responsive: true });
        });
        
        // Kümülatif butonu handler
        maddeCumulativeBtn.addEventListener('click', function() {
            setMaddeMode(maddeCumulativeBtn);
            if (true) {
                // Kümülatif moda geç
                let newLineData = JSON.parse(JSON.stringify(originalMaddeLineData));
                
                let cumValues = null;
                
                // Line grafiği için kümülatif hesapla
                if (newLineData.data.length > 0) {
                    cumValues = calculateMaddeCumulative(originalMaddeLineData.data[0].y);
                    let newMonths = addMaddeJanuaryToMonths(originalMaddeLineData.data[0].x);
                    newLineData.data[0].x = newMonths;
                    newLineData.data[0].y = cumValues;
                    newLineData.data[0].text = cumValues.map(v => v !== null && v < 0 ? '   ' + v.toFixed(2) : (v !== null ? v.toFixed(2) : ''));
                    newLineData.data[0].cliponaxis = false; // Text'lerin grafik dışına çıkmasına izin ver
                }
                newLineData.layout.title.text = newLineData.layout.title.text.replace('Aylık Değişim Oranları', 'Kümülatif Aylık Değişim Oranları (Ocak 2025 = 0)');
                
                // Y ekseni aralığını kümülatif değerlere göre ayarla
                if (cumValues && cumValues.length > 0) {
                    let validValues = cumValues.filter(v => v !== null);
                    if (validValues.length > 0) {
                        let yMin = Math.min(...validValues);
                        let yMax = Math.max(...validValues);
                        let yRange = yMax - yMin;
                        // Line chart için makul marj
                        let yMarginTop = yRange * 0.2;  // 20%
                        let yMarginBottom = yRange * 0.1;
                        newLineData.layout.yaxis.range = [
                            Math.min(0, yMin - yMarginBottom),
                            yMax + yMarginTop
                        ];
                    }
                }
                // Grafik kenar boşluklarını ve yüksekliği ayarla
                newLineData.layout.margin = { l: 10, r: 40, t: 60, b: 20 };
                newLineData.layout.height = 450;
                newLineData.layout.uniformtext = { mode: 'hide', minsize: 8 };
                if (newLineData.layout.xaxis) {
                    newLineData.layout.xaxis.automargin = true;
                }
                
                Plotly.react('monthly-change-line-chart', newLineData.data, newLineData.layout, { 
                    displayModeBar: false, 
                    responsive: true,
                    staticPlot: false
                });
            }
        });

        // Window resize event to ensure charts fill the container
        window.addEventListener('resize', function () {
            setTimeout(function () {
                Plotly.Plots.resize('monthly-change-line-chart');
            }, 100);
        });
    </script>
    {% endif %}
    {% if selected_madde == 'TÜFE' %}
    <script>
        var barGraphs = {{ bar_graphJSON | safe }};
        var lineGraphs = {{ line_graphJSON | safe }};
        
        // Orijinal verileri sakla
        var originalBarData = JSON.parse(JSON.stringify(barGraphs));
        var originalLineData = JSON.parse(JSON.stringify(lineGraphs));
        
        // Kümülatif hesaplama fonksiyonu (Ocak 2025 = 0 ile başlar)
        function calculateCumulative(values) {
            let cumulative = [0]; // Ocak 2025 = 0
            let cumulativeProduct = 1;
            
            for (let i = 0; i < values.length; i++) {
                if (values[i] !== null && values[i] !== undefined) {
                    cumulativeProduct *= (1 + values[i] / 100);
                    cumulative.push((cumulativeProduct - 1) * 100);
                } else {
                    cumulative.push(null);
                }
            }
            return cumulative;
        }
        
        // Ay listesine Ocak 2025 ekle
        function addJanuaryToMonths(months) {
            let newMonths = ['Ocak 2025'];
            return newMonths.concat(months);
        }
        
        Plotly.newPlot('bar-compare-chart', barGraphs.data, barGraphs.layout, { displayModeBar: false, responsive: true });
        Plotly.newPlot('line-compare-chart', lineGraphs.data, lineGraphs.layout, { displayModeBar: false, responsive: true });

        // Toggle logic for comparison chart
        const barBtn = document.getElementById('bar-btn');
        const lineBtn = document.getElementById('line-btn');
        const barChart = document.getElementById('bar-compare-chart');
        const lineChart = document.getElementById('line-compare-chart');
        const cumulativeCheckbox = document.getElementById('cumulative-checkbox');

        function setActive(btn) {
        barBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
        barBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        
        lineBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
        lineBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        
        btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        btn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
    }
        
        // Kümülatif checkbox handler
        cumulativeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Kümülatif moda geç
                let newBarData = JSON.parse(JSON.stringify(originalBarData));
                let newLineData = JSON.parse(JSON.stringify(originalLineData));
                
                // Bar grafiği için her trace'i kümülatif yap
                let allValues = [];
                newBarData.data.forEach(function(trace, idx) {
                    let cumValues = calculateCumulative(originalBarData.data[idx].y);
                    let newMonths = addJanuaryToMonths(originalBarData.data[idx].x);
                    trace.x = newMonths;
                    trace.y = cumValues;
                    trace.text = cumValues.map(v => v !== null ? '<b>' + v.toFixed(2) + '</b>' : '');
                    trace.cliponaxis = false; // Text'lerin grafik dışına çıkmasına izin ver
                    trace.constraintext = 'none'; // Text'leri kısıtlama
                    allValues = allValues.concat(cumValues.filter(v => v !== null));
                });
                newBarData.layout.title.text = 'Kümülatif Aylık Web TÜFE ve TÜİK TÜFE Karşılaştırması (Ocak 2025 = 0)';
                
                // Y ekseni aralığını kümülatif değerlere göre ayarla
                if (allValues.length > 0) {
                    let yMin = Math.min(...allValues);
                    let yMax = Math.max(...allValues);
                    let yRange = yMax - yMin;
                    // Üstteki text'ler için makul marj (20%)
                    let yMarginTop = yRange * 0.2;
                    let yMarginBottom = yRange * 0.1;
                    newBarData.layout.yaxis.range = [
                        Math.min(0, yMin - yMarginBottom),
                        yMax + yMarginTop
                    ];
                }
                // Grafik kenar boşluklarını ayarla
                newBarData.layout.margin = { l: 10, r: 40, t: 60, b: 20 };  // Sağ marjı artırdık
                newBarData.layout.uniformtext = { mode: 'hide', minsize: 8 };
                if (newBarData.layout.xaxis) {
                    newBarData.layout.xaxis.automargin = true;
                }
                
                // Line grafiği için her trace'i kümülatif yap
                newLineData.data.forEach(function(trace, idx) {
                    let cumValues = calculateCumulative(originalLineData.data[idx].y);
                    let newMonths = addJanuaryToMonths(originalLineData.data[idx].x);
                    trace.x = newMonths;
                    trace.y = cumValues;
                    trace.text = cumValues.map(v => v !== null && v < 0 ? '   ' + v.toFixed(2) : (v !== null ? v.toFixed(2) : ''));
                    trace.cliponaxis = false; // Text'lerin grafik dışına çıkmasına izin ver
                });
                newLineData.layout.title.text = 'Kümülatif Aylık Web TÜFE ve TÜİK TÜFE Karşılaştırması (Ocak 2025 = 0)';
                
                // Y ekseni aralığını kümülatif değerlere göre ayarla (line chart için de)
                if (allValues.length > 0) {
                    let yMin = Math.min(...allValues);
                    let yMax = Math.max(...allValues);
                    let yRange = yMax - yMin;
                    // Line chart için makul marj
                    let yMarginTop = yRange * 0.2;  // 20%
                    let yMarginBottom = yRange * 0.1;
                    newLineData.layout.yaxis.range = [
                        Math.min(0, yMin - yMarginBottom),
                        yMax + yMarginTop
                    ];
                }
                // Grafik kenar boşluklarını ayarla
                newLineData.layout.margin = { l: 10, r: 40, t: 60, b: 20 };  // Sağ marjı artırdık
                newLineData.layout.uniformtext = { mode: 'hide', minsize: 8 };
                if (newLineData.layout.xaxis) {
                    newLineData.layout.xaxis.automargin = true;
                }
                
                Plotly.react('bar-compare-chart', newBarData.data, newBarData.layout, { 
                    displayModeBar: false, 
                    responsive: true,
                    staticPlot: false
                });
                Plotly.react('line-compare-chart', newLineData.data, newLineData.layout, { 
                    displayModeBar: false, 
                    responsive: true,
                    staticPlot: false
                });
            } else {
                // Normal moda geri dön
                Plotly.react('bar-compare-chart', originalBarData.data, originalBarData.layout, { displayModeBar: false, responsive: true });
                Plotly.react('line-compare-chart', originalLineData.data, originalLineData.layout, { displayModeBar: false, responsive: true });
            }
        });

        barBtn.addEventListener('click', function () {
            barChart.classList.remove('hidden');
            lineChart.classList.add('hidden');
            setActive(barBtn);
            setTimeout(function () {
                Plotly.Plots.resize('bar-compare-chart');
            }, 100);
        });

        lineBtn.addEventListener('click', function () {
            lineChart.classList.remove('hidden');
            barChart.classList.add('hidden');
            setActive(lineBtn);
            setTimeout(function () {
                Plotly.Plots.resize('line-compare-chart');
            }, 100);
        });

        // Varsayılan olarak bar aktif
        setActive(barBtn);

        // Window resize event to ensure charts fill the container
        window.addEventListener('resize', function () {
            if (!lineChart.classList.contains('hidden')) {
                setTimeout(function () {
                    Plotly.Plots.resize('line-compare-chart');
                }, 100);
            }
            if (!barChart.classList.contains('hidden')) {
                setTimeout(function () {
                    Plotly.Plots.resize('bar-compare-chart');
                }, 100);
            }
        });
    </script>
    {% endif %}
{% endblock %}
