{% extends "base.html" %}

{% block title %}TÜFE - Web TÜFE{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="card-modern p-6 relative overflow-hidden">
                <form method="post" id="tufe-form" class="mb-6">
                    <input type="hidden" name="view_type" id="view_type_input" value="{{ view_type or 'graph' }}">
                    <label for="madde" class="block text-sm font-medium text-gray-700 mb-1">Madde Seçin:</label>
                    <div class="flex items-center gap-4">
                        <div class="relative w-full">
                            <select name="madde" id="madde" onchange="this.form.submit()"
                                class="appearance-none w-full px-4 py-2 pr-10 rounded-lg border border-gray-300 bg-white shadow focus:outline-none focus:ring-2 focus:ring-[#EF476F] focus:border-[#EF476F] text-base font-semibold text-gray-700 transition duration-150 ease-in-out cursor-pointer">
                            <option value="TÜFE" {% if selected_madde=='TÜFE' %}selected{% endif %}>TÜFE</option>
                            {% for madde in madde_names %}
                            <option value="{{ madde }}" {% if selected_madde==madde %}selected{% endif %}>{{ madde }}
                            </option>
                            {% endfor %}
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5.23 7.21a.75.75 0 011.06.02L10 10.584l3.71-3.354a.75.75 0 111.02 1.1l-4.25 3.84a.75.75 0 01-1.02 0l-4.25-3.84a.75.75 0 01.02-1.06z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="inline-flex rounded-lg border border-indigo-200 overflow-hidden flex-shrink-0">
                            <button type="button" onclick="setViewType('graph')"
                                aria-pressed="{{ 'true' if view_type == 'graph' else 'false' }}"
                                class="px-4 py-2 text-sm font-semibold transition-colors duration-150 focus:outline-none border-r border-indigo-200 {% if view_type == 'graph' %}bg-indigo-600 text-white shadow-inner{% else %}bg-white text-gray-600 hover:bg-indigo-50{% endif %}">
                                Grafik
                            </button>
                            <button type="button" onclick="setViewType('data')"
                                aria-pressed="{{ 'true' if view_type == 'data' else 'false' }}"
                                class="px-4 py-2 text-sm font-semibold transition-colors duration-150 focus:outline-none {% if view_type == 'data' %}bg-indigo-600 text-white shadow-inner{% else %}bg-white text-gray-600 hover:bg-indigo-50{% endif %}">
                                Veri
                            </button>
                        </div>
                    </div>
                </form>
                {% if last_date %}
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl shadow-md p-6 border border-blue-100">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wide">Yıllık Değişim</h3>
                        <p class="text-4xl font-bold mb-1 {% if change_rate > 0 %}text-red-600{% elif change_rate < 0 %}text-green-600{% else %}text-gray-700{% endif %}">
                            {% if change_rate is not none %}
                            {{ '%.2f' % change_rate }}%
                            {% else %}
                            -
                            {% endif %}
                        </p>
                        <p class="text-xs text-gray-500">Son 12 aya göre</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl shadow-md p-6 border border-orange-100" style="overflow: visible;">
                        <div class="flex items-center gap-2" style="overflow: visible;">
                            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide">{{ month_name }} Aylık Değişim</h3>
                            <div class="relative group" style="overflow: visible;">
                                <div class="flex items-center justify-center w-5 h-5 bg-indigo-100 rounded-full cursor-help hover:bg-indigo-200 transition-colors duration-200 animate-pulse hover:animate-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="absolute left-0 top-7 w-80 bg-gray-900 text-white text-xs rounded-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 shadow-xl pointer-events-none group-hover:pointer-events-auto" style="min-width: 320px; white-space: normal; word-wrap: break-word;">
                                    <p class="leading-relaxed">
                                        Aylık değişim oranı nihai verinin kesinleştiği 24.güne kadar çeşitli modellerle ay sonu için verinin trendi ile tahmin edilmektedir.<br>
                                        Ayın 24'ünde nihai veri 24.güne kadar olan ortalamanın önceki ayın aynı dönemdeki ortalamasına göre değişimi ile oluşur.
                                    </p>
                                    <div class="absolute -top-2 left-4 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-gray-900"></div>
                                </div>
                            </div>
                        </div>
                        <p class="text-4xl font-bold mb-1 {% if monthly_change > 0 %}text-red-600{% elif monthly_change < 0 %}text-green-600{% else %}text-gray-700{% endif %}">
                            {% if monthly_change is not none %}
                            {{ '%.2f' % monthly_change }}%
                            {% else %}
                            -
                            {% endif %}
                        </p>
                        <p class="text-xs text-gray-500">Bir önceki aya göre</p>
                    </div>
                </div>
                {% if view_type == 'graph' %}
                <!-- Chart view -->
                <div id="chart-view-tufe" class="w-full overflow-x-auto">
                    <div id="tufe-chart" class="w-full" style="min-width: 0;"></div>
                </div>
                {% if selected_madde != 'TÜFE' %}
                <div class="mt-12 w-full">
                    <!-- View toggle buttons (above monthly chart) -->
                    <div class="mb-4 flex gap-2 z-10" style="position: relative;">
                        <button id="btn-grafik-monthly" onclick="toggleViewMonthly('grafik')" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-md active whitespace-nowrap" style="display: inline-block;">
                            Grafik
                        </button>
                        <button id="btn-veri-monthly" onclick="toggleViewMonthly('veri')" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:text-indigo-600 shadow-sm whitespace-nowrap" style="display: inline-block;">
                            Veri
                        </button>
                    </div>
                    <!-- Monthly chart view -->
                    <div id="monthly-chart-view" class="w-full">
                        <div class="btn-group flex gap-3 justify-end mb-6">
                            <button id="madde-monthly-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-md active">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                        Aylık
                                    </button>
                            <button id="madde-cumulative-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:text-indigo-600 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                        </svg>
                                        Yıllık
                                    </button>
                        </div>
                        <div id="monthly-change-line-chart" class="w-full" style="width: 100% !important;">
                        </div>
                    </div>
                    <!-- Monthly data view -->
                    <div id="monthly-data-view" class="w-full hidden">
                        <div class="mb-4 flex justify-end gap-2">
                            <a href="/download/maddeler-aylik/csv" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow transition flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                CSV İndir
                            </a>
                            <a href="/download/maddeler-aylik/xlsx" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow transition flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Excel İndir
                            </a>
                        </div>
                        <div class="w-full border border-gray-200 rounded-lg overflow-hidden">
                            {% if maddeler_monthly_data and maddeler_monthly_columns %}
                            <div class="overflow-x-auto overflow-y-auto max-h-[600px]">
                            <table class="min-w-full divide-y divide-gray-200 bg-white" style="min-width: max-content;">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        {% for col in maddeler_monthly_columns %}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ col }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for row in maddeler_monthly_data %}
                                    <tr class="hover:bg-gray-50">
                                        {% for col in maddeler_monthly_columns %}
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            {% if col == 'Tarih' %}
                                                {{ row[col] if row[col] else '-' }}
                                            {% else %}
                                                {{ "%.2f"|format(row[col]) if row[col] is not none else '-' }}
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            </div>
                            {% else %}
                            <div class="p-8 text-center text-gray-500">
                                <p>Veri bulunamadı.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if selected_madde == 'TÜFE' %}
                <div class="mt-12">
                    <!-- View toggle buttons removed for performance -->
                    <!-- Comparison chart view -->
                    <div id="tufe-compare-chart-view" class="w-full">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-3">
                                <button id="tufe-monthly-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-md active">
                                    Aylık
                                </button>
                                <button id="tufe-yearly-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:text-indigo-600 shadow-sm">
                                    Yıllık
                                </button>
                            </div>
                    <div id="bar-line-btn-group" class="btn-group flex gap-3 justify-end">
                        <button id="bar-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-md active">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="12" width="4" height="8" />
                                        <rect x="9" y="8" width="4" height="12" />
                                        <rect x="15" y="4" width="4" height="16" />
                                    </svg>
                                    Bar Grafik
                                </button>
                        <button id="line-btn" class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:text-indigo-600 shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M4 16l4-4 4 4 8-8" />
                                    </svg>
                                    Line Grafik
                                </button>
                            </div>
                        </div>
                        <div id="bar-compare-chart" class="w-full"></div>
                        <div id="line-compare-chart" class="w-full hidden"></div>
                    </div>
                </div>
                {% endif %}
                {% elif view_type == 'data' %}
                <div class="mt-6">
                    <div class="mb-4 flex justify-end gap-2">
                        <a href="/download/tufe-endeksler/csv"
                            class="inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 transition-colors">
                            Endeks CSV indir
                        </a>
                        <a href="/download/tufe-endeksler/xlsx"
                            class="inline-flex items-center gap-2 px-3 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 transition-colors">
                            Endeks Excel indir
                        </a>
                        <a href="/download/maddeler-aylik/csv"
                            class="inline-flex items-center gap-2 px-3 py-2 rounded-md bg-white text-indigo-700 text-sm font-semibold border border-indigo-200 hover:bg-indigo-50 transition-colors">
                            Aylık CSV indir
                        </a>
                        <a href="/download/maddeler-aylik/xlsx"
                            class="inline-flex items-center gap-2 px-3 py-2 rounded-md bg-white text-indigo-700 text-sm font-semibold border border-indigo-200 hover:bg-indigo-50 transition-colors">
                            Aylık Excel indir
                        </a>
                    </div>

                    {% if endeks_data and endeks_columns %}
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Endeks Verileri</h3>
                    <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-600 text-white">
                                <tr>
                                    {% for col in endeks_columns %}
                                    <th scope="col"
                                        class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wide {% if loop.first %}sticky left-0 bg-indigo-600 z-10{% endif %}">
                                        {{ col }}
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for row in endeks_data %}
                                <tr class="hover:bg-gray-50">
                                    {% for col in endeks_columns %}
                                    <td class="py-3 px-4 text-sm text-gray-700 {% if loop.first %}sticky left-0 bg-white z-10 font-medium{% endif %}">
                                        {% set val = row.get(col) %}
                                        {% if val is not none and val != '' %}
                                            {% if val is number %}
                                                {{ "%.2f"|format(val) }}
                                            {% else %}
                                                {{ val }}
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500">Endeks verisi bulunamadı.</p>
                    {% endif %}

                    {% if maddeler_monthly_data and maddeler_monthly_columns %}
                    <h3 class="text-lg font-semibold text-gray-800 mt-8 mb-3">Aylık Değişim Verileri</h3>
                    <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-600 text-white">
                                <tr>
                                    {% for col in maddeler_monthly_columns %}
                                    <th scope="col"
                                        class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wide {% if loop.first %}sticky left-0 bg-indigo-600 z-10{% endif %}">
                                        {{ col }}
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for row in maddeler_monthly_data %}
                                <tr class="hover:bg-gray-50">
                                    {% for col in maddeler_monthly_columns %}
                                    <td class="py-3 px-4 text-sm text-gray-700 {% if loop.first %}sticky left-0 bg-white z-10 font-medium{% endif %}">
                                        {% set val = row.get(col) %}
                                        {% if val is not none and val != '' %}
                                            {% if val is number %}
                                                {{ "%.2f"|format(val) }}
                                            {% else %}
                                                {{ val }}
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500 mt-6">Aylık veri bulunamadı.</p>
                    {% endif %}
                </div>
                {% endif %}
                {% else %}
                <div class="text-center text-red-600 font-bold text-lg py-12">Veri bulunamadı.</div>
                {% endif %}
            </div>
            </div>
{% endblock %}

{% block scripts %}
    <script>
        const isGraphView = '{{ view_type or "graph" }}' === 'graph';
        if (isGraphView) {
            var graphs = {{ graphJSON | safe }};
            // Update layout to ensure chart fits within container
            if (graphs.layout) {
                graphs.layout.autosize = true;
                graphs.layout.width = null; // Let Plotly calculate width
                if (graphs.layout.margin) {
                    graphs.layout.margin.l = Math.min(graphs.layout.margin.l || 20, 40);
                    graphs.layout.margin.r = Math.min(graphs.layout.margin.r || 20, 40);
                }
            }
            Plotly.newPlot('tufe-chart', graphs.data, graphs.layout, { 
                displayModeBar: false, 
                responsive: true,
                autosize: true
            });
            window.addEventListener('resize', function () {
                Plotly.Plots.resize('tufe-chart');
            });
        }

        function setViewType(type) {
            const input = document.getElementById('view_type_input');
            if (input) input.value = type;
            const form = document.getElementById('tufe-form');
            if (form) form.submit();
        }
    </script>
    {% if selected_madde != 'TÜFE' %}
    <script>
        var monthlyChangeLineGraph = {{ line_graphJSON | safe }};
        var yearlyChangeLineGraph = {{ yearly_line_graphJSON | safe if yearly_line_graphJSON else 'null' }};
        
        // Orijinal verileri sakla (aylık veri)
        var originalMaddeLineData = JSON.parse(JSON.stringify(monthlyChangeLineGraph));
        var yearlyMaddeLineData = yearlyChangeLineGraph ? JSON.parse(JSON.stringify(yearlyChangeLineGraph)) : null;
        
        
        Plotly.newPlot('monthly-change-line-chart', monthlyChangeLineGraph.data, monthlyChangeLineGraph.layout, { displayModeBar: false, responsive: true });

        const maddeLineChart = document.getElementById('monthly-change-line-chart');
        const maddeMonthlyBtn = document.getElementById('madde-monthly-btn');
        const maddeCumulativeBtn = document.getElementById('madde-cumulative-btn');
        
        function setMaddeMode(btn) {
        maddeMonthlyBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
        maddeMonthlyBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        
        maddeCumulativeBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
        maddeCumulativeBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        
        btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
        btn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
    }
        
        // Aylık butonu handler
        maddeMonthlyBtn.addEventListener('click', function() {
            setMaddeMode(maddeMonthlyBtn);
            // Normal moda geri dön
            Plotly.react('monthly-change-line-chart', originalMaddeLineData.data, originalMaddeLineData.layout, { displayModeBar: false, responsive: true });
        });
        
        // Yıllık butonu handler
        maddeCumulativeBtn.addEventListener('click', function() {
            setMaddeMode(maddeCumulativeBtn);
            // Yıllık veriyi göster
            if (yearlyMaddeLineData) {
                Plotly.react('monthly-change-line-chart', yearlyMaddeLineData.data, yearlyMaddeLineData.layout, { displayModeBar: false, responsive: true });
            } else {
                // Yıllık veri yoksa, aylık veriyi göster
                Plotly.react('monthly-change-line-chart', originalMaddeLineData.data, originalMaddeLineData.layout, { displayModeBar: false, responsive: true });
            }
        });

        // Window resize event to ensure charts fill the container
        window.addEventListener('resize', function () {
            setTimeout(function () {
                Plotly.Plots.resize('monthly-change-line-chart');
            }, 100);
        });

        // Initialize monthly view toggle - ensure buttons are visible
        setTimeout(function() {
            if (document.getElementById('btn-grafik-monthly') && typeof toggleViewMonthly === 'function') {
                toggleViewMonthly('grafik');
            }
        }, 100);
    </script>
    {% endif %}
    {% if selected_madde == 'TÜFE' %}
    <script>
        var yearlyBarGraphs = {{ bar_graphJSON | safe }};
        var yearlyLineGraphs = {{ line_graphJSON | safe }};
        var monthlyBarGraphs = {{ tufe_monthly_bar_graphJSON | safe if tufe_monthly_bar_graphJSON else 'null' }};
        var monthlyLineGraphs = {{ tufe_monthly_line_graphJSON | safe if tufe_monthly_line_graphJSON else 'null' }};
        
        // Backend'den gelen veri zaten marker renklerine sahip, ek kontrol gerekmiyor
        
        // Başlangıçta aylık grafikleri çiz (varsayılan mod)
        if (monthlyBarGraphs && monthlyBarGraphs.data && monthlyBarGraphs.layout) {
            Plotly.newPlot('bar-compare-chart', monthlyBarGraphs.data, monthlyBarGraphs.layout, { displayModeBar: false, responsive: true });
        }
        if (monthlyLineGraphs && monthlyLineGraphs.data && monthlyLineGraphs.layout) {
            Plotly.newPlot('line-compare-chart', monthlyLineGraphs.data, monthlyLineGraphs.layout, { displayModeBar: false, responsive: true });
        }
        
        // Yıllık grafikleri de başlangıçta çiz (gizli, aylık gibi)
        // Not: Yıllık grafikler aylık grafiklerle aynı container'ı kullanıyor, 
        // bu yüzden sadece veri hazır olmalı, çizim updateCharts() ile yapılacak

        // Toggle logic for comparison chart
        const barBtn = document.getElementById('bar-btn');
        const lineBtn = document.getElementById('line-btn');
        const barLineBtnGroup = document.getElementById('bar-line-btn-group');
        const barChart = document.getElementById('bar-compare-chart');
        const lineChart = document.getElementById('line-compare-chart');
        const tufeMonthlyBtn = document.getElementById('tufe-monthly-btn');
        const tufeYearlyBtn = document.getElementById('tufe-yearly-btn');
        
        var currentViewType = 'monthly'; // 'yearly' or 'monthly'

        function setActiveChartType(btn) {
            tufeMonthlyBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
            tufeMonthlyBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            
            tufeYearlyBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
            tufeYearlyBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            
            btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            btn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
        }

        function setActiveChart(btn) {
            barBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
            barBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            
            lineBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
            lineBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            
            btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            btn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md');
        }
        
        function updateCharts() {
            var barData, lineData;
            if (currentViewType === 'monthly') {
                barData = monthlyBarGraphs;
                lineData = monthlyLineGraphs;
            } else {
                barData = yearlyBarGraphs;
                lineData = yearlyLineGraphs;
            }
            
            // Her iki durumda da her iki grafiği de güncelle (aylık gibi)
            if (barData && barData.data && barData.layout) {
                Plotly.react('bar-compare-chart', barData.data, barData.layout, { displayModeBar: false, responsive: true });
            }
            if (lineData && lineData.data && lineData.layout) {
                Plotly.react('line-compare-chart', lineData.data, lineData.layout, { displayModeBar: false, responsive: true });
            }
        }
        
        tufeMonthlyBtn.addEventListener('click', function() {
            currentViewType = 'monthly';
            setActiveChartType(tufeMonthlyBtn);
            // Bar/Line butonlarını göster
            if (barLineBtnGroup) {
                barLineBtnGroup.style.display = 'flex';
            }
            updateCharts();
            setTimeout(function() {
                if (!lineChart.classList.contains('hidden')) {
                    Plotly.Plots.resize('line-compare-chart');
                }
                if (!barChart.classList.contains('hidden')) {
                    Plotly.Plots.resize('bar-compare-chart');
                }
            }, 100);
        });
        
        tufeYearlyBtn.addEventListener('click', function() {
            currentViewType = 'yearly';
            setActiveChartType(tufeYearlyBtn);
            // Bar/Line butonlarını göster
            if (barLineBtnGroup) {
                barLineBtnGroup.style.display = 'flex';
            }
            // Yıllık seçildiğinde otomatik olarak bar grafiğini göster
            // Önce container'ı görünür yap, sonra grafiği çiz (aylık gibi)
            lineChart.classList.add('hidden');
            barChart.classList.remove('hidden');
            setActiveChart(barBtn);
            // Aylık gibi newPlot ile çiz (aylık başlangıçta newPlot kullanıyor)
            // Container görünür olduktan sonra çiz
            setTimeout(function() {
                if (yearlyBarGraphs && yearlyBarGraphs.data && yearlyBarGraphs.layout) {
                    Plotly.purge('bar-compare-chart');
                    Plotly.newPlot('bar-compare-chart', yearlyBarGraphs.data, yearlyBarGraphs.layout, { displayModeBar: false, responsive: true });
                }
                if (yearlyLineGraphs && yearlyLineGraphs.data && yearlyLineGraphs.layout) {
                    Plotly.purge('line-compare-chart');
                    Plotly.newPlot('line-compare-chart', yearlyLineGraphs.data, yearlyLineGraphs.layout, { displayModeBar: false, responsive: true });
                }
                // Resize yap
                if (!barChart.classList.contains('hidden')) {
                    Plotly.Plots.resize('bar-compare-chart');
                }
            }, 50);
        });

        barBtn.addEventListener('click', function () {
            barChart.classList.remove('hidden');
            lineChart.classList.add('hidden');
            setActiveChart(barBtn);
            setTimeout(function () {
                Plotly.Plots.resize('bar-compare-chart');
            }, 100);
        });

        lineBtn.addEventListener('click', function () {
            lineChart.classList.remove('hidden');
            barChart.classList.add('hidden');
            setActiveChart(lineBtn);
            setTimeout(function () {
                Plotly.Plots.resize('line-compare-chart');
            }, 100);
        });

        // Varsayılan olarak aylık ve bar aktif (grafikler zaten başlangıçta çizildi)
        setActiveChartType(tufeMonthlyBtn);
        setActiveChart(barBtn);

        // Window resize event to ensure charts fill the container
        window.addEventListener('resize', function () {
            if (!lineChart.classList.contains('hidden')) {
                setTimeout(function () {
                    Plotly.Plots.resize('line-compare-chart');
                }, 100);
            }
            if (!barChart.classList.contains('hidden')) {
                setTimeout(function () {
                    Plotly.Plots.resize('bar-compare-chart');
                }, 100);
            }
        });
    </script>
    {% endif %}
    <script>
    function toggleViewTufe(viewType) {
        const grafikBtn = document.getElementById('btn-grafik-tufe');
        const veriBtn = document.getElementById('btn-veri-tufe');
        const chartView = document.getElementById('chart-view-tufe');
        const dataView = document.getElementById('data-view-tufe');

        if (viewType === 'grafik') {
            grafikBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            grafikBtn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md', 'active');
            veriBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md', 'active');
            veriBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            
            chartView.classList.remove('hidden');
            dataView.classList.add('hidden');
        } else {
            veriBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            veriBtn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md', 'active');
            grafikBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md', 'active');
            grafikBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            
            dataView.classList.remove('hidden');
            chartView.classList.add('hidden');
        }
    }

    function toggleViewMonthly(viewType) {
        const grafikBtn = document.getElementById('btn-grafik-monthly');
        const veriBtn = document.getElementById('btn-veri-monthly');
        const chartView = document.getElementById('monthly-chart-view');
        const dataView = document.getElementById('monthly-data-view');

        if (!grafikBtn || !veriBtn || !chartView || !dataView) {
            return; // Elements not found, exit early
        }

        if (viewType === 'grafik') {
            grafikBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            grafikBtn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md', 'active');
            veriBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md', 'active');
            veriBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            
            chartView.classList.remove('hidden');
            dataView.classList.add('hidden');
        } else {
            veriBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            veriBtn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md', 'active');
            grafikBtn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-md', 'active');
            grafikBtn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50', 'hover:text-indigo-600', 'shadow-sm');
            
            dataView.classList.remove('hidden');
            chartView.classList.add('hidden');
        }
    }

    // toggleViewTufeCompare function removed for performance optimization
    
    // Initialize monthly view toggle on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('btn-grafik-monthly')) {
            toggleViewMonthly('grafik');
        }
    });
    </script>
{% endblock %}
